<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>90分钟圆环倒计时</title>
    <link data-trunk rel="css" href="./dist/tailwind.css">
    <script>
        // 加载Tauri脚本
        function loadTauriScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                // 使用官方推荐的CDN链接
                script.src = 'https://unpkg.com/@tauri-apps/api@2.0.0-alpha.13/dist/tauri.iife.js';
                script.onload = function() {
                    console.log('Tauri脚本加载完成');
                    resolve(window.__TAURI__);
                };
                script.onerror = function() {
                    console.error('Tauri脚本加载失败，尝试备用CDN');
                    // 尝试使用备用CDN
                    script.src = 'https://cdn.jsdelivr.net/npm/@tauri-apps/api@2.0.0-alpha.13/dist/tauri.iife.js';
                    script.onload = function() {
                        console.log('备用CDN加载Tauri脚本成功');
                        resolve(window.__TAURI__);
                    };
                    script.onerror = function() {
                        console.error('备用CDN加载Tauri脚本也失败');
                        reject(new Error('无法加载Tauri脚本'));
                    };
                    document.head.appendChild(script);
                };
                document.head.appendChild(script);
            });
        }

        // 加载编译后的WebAssembly模块
        function loadWasmModule() {
            // 使用绝对路径确保正确加载
            const basePath = '/dist';
            const moduleName = 'beep-ui-7eb184cf2d003b81';
            const modulePath = `${basePath}/${moduleName}.js`;
            const wasmPath = `${basePath}/${moduleName}_bg.wasm`;
            console.log(`尝试加载WebAssembly模块: ${modulePath}`);
            console.log(`WASM二进制文件路径: ${wasmPath}`);

            // 验证模块路径并加载
            validateModulePath(modulePath, wasmPath)
                .then(isValid => isValid ? loadModuleScript(modulePath, wasmPath) : loadWasmBinary(wasmPath))
                .catch(error => handleModuleLoadError(error, wasmPath));
        }

        // 验证模块路径是否有效
        async function validateModulePath(modulePath, wasmPath) {
            try {
                const response = await fetch(modulePath, {
                    method: 'GET',
                    headers: { 'Accept': 'application/javascript' }
                });

                if (!response.ok) {
                    console.error('WebAssembly模块文件不存在，状态码:', response.status);
                    return false;
                }

                console.log('WebAssembly模块文件存在，状态码:', response.status);
                const contentType = response.headers.get('content-type');
                console.log('WebAssembly模块文件类型:', contentType);

                if (!contentType || !contentType.includes('javascript')) {
                    console.warn('WebAssembly模块文件类型不是JavaScript，可能导致加载问题');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('无法检查WebAssembly模块文件:', error);
                return false;
            }
        }

        // 加载模块脚本
        function loadModuleScript(modulePath, wasmPath) {
            console.log('开始加载WebAssembly模块:', modulePath);
            const script = document.createElement('script');
            script.src = modulePath;
            script.type = 'text/javascript';

            // 添加错误处理函数
            script.onerror = function(event) {
                console.error('WebAssembly模块加载失败:', event);
                console.error('错误类型:', event.type);
                console.error('错误目标:', event.target.src);
                handleModuleLoadError(new Error('脚本加载失败'), wasmPath);
            };

            // 添加加载完成处理函数
            script.onload = function() {
                console.log('WebAssembly模块脚本加载完成');
                initializeWasmModule(wasmPath);
            };

            // 将脚本添加到文档
            document.body.appendChild(script);
            console.log('WebAssembly模块脚本已添加到文档');
        }

        // 初始化WASM模块
        function initializeWasmModule(wasmPath) {
            // 检查模块是否已加载到全局作用域
            console.log('检查全局作用域中的初始化函数:');
            console.log('__wbg_init存在:', typeof window.__wbg_init !== 'undefined');
            console.log('initSync存在:', typeof window.initSync !== 'undefined');
            console.log('wasm存在:', typeof window.wasm !== 'undefined');

            // 打印所有与wasm相关的全局变量
            const wasmGlobals = Object.keys(window).filter(key => key.includes('wasm') || key.includes('init'));
            console.log('WASM相关全局变量:', wasmGlobals);

            // 尝试异步初始化
            if (window.__wbg_init) {
                try {
                    console.log('尝试异步初始化WebAssembly模块');
                    window.__wbg_init()
                        .then(wasm => handleInitializedWasm(wasm))
                        .catch(error => handleInitializationError(error, wasmPath));
                } catch (error) {
                    handleInitializationError(error, wasmPath);
                }
                return;
            }

            // 尝试同步初始化
            if (window.initSync) {
                try {
                    console.log('尝试同步初始化WebAssembly模块');
                    const wasm = window.initSync();
                    handleInitializedWasm(wasm);
                } catch (error) {
                    handleInitializationError(error, wasmPath);
                }
                return;
            }

            // 检查是否已初始化
            if (window.wasm) {
                console.log('WebAssembly模块已初始化，但未找到明确的初始化方法');
                handleInitializedWasm(window.wasm);
                return;
            }

            // 所有初始化方法都失败
            console.error('WebAssembly模块已加载，但未找到初始化方法');
            loadWasmBinary(wasmPath);
        }

        // 处理初始化成功的WASM模块
        function handleInitializedWasm(wasm) {
            console.log('WebAssembly模块初始化成功', wasm);
            window.wasm = wasm;
            // 初始化完成后，尝试调用模块的方法
            if (wasm && wasm.start) {
                console.log('尝试调用WebAssembly模块的start方法');
                wasm.start();
            }
        }

        // 处理初始化错误
        function handleInitializationError(error, wasmPath) {
            console.error('WebAssembly模块初始化失败:', error);
            console.error('错误堆栈:', error.stack);
            loadWasmBinary(wasmPath);
        }

        // 处理模块加载错误
        function handleModuleLoadError(error, wasmPath) {
            console.error('WebAssembly模块加载失败:', error);
            console.log(`尝试直接加载WASM文件: ${wasmPath}`);
            loadWasmBinary(wasmPath);
        }

        // 直接加载WASM二进制文件的备用方法
        function loadWasmBinary(wasmPath) {
            console.log('尝试直接加载WASM二进制文件:', wasmPath);

            fetch(wasmPath, { headers: { 'Accept': 'application/wasm' } })
                .then(response => checkResponseStatus(response, wasmPath))
                .then(response => checkContentType(response))
                .then(response => response.arrayBuffer())
                .then(bytes => validateWasmBinary(bytes, wasmPath))
                .then(bytes => instantiateWasmModule(bytes))
                .catch(error => handleWasmBinaryError(error, wasmPath));
        }

        // 检查响应状态
        function checkResponseStatus(response, wasmPath) {
            if (!response.ok) {
                throw new Error(`WASM文件加载失败，状态码: ${response.status}`);
            }
            return response;
        }

        // 检查内容类型
        function checkContentType(response) {
            const contentType = response.headers.get('content-type');
            console.log('WASM文件类型:', contentType);
            // 宽松检查MIME类型，允许常见的WASM MIME类型和通用二进制类型
            if (!contentType || !(contentType.includes('wasm') || contentType.includes('octet-stream') || contentType.includes('binary'))) {
                console.warn('WASM文件类型不正确，可能导致问题');
                // 尝试使用Trunk配置的MIME类型重新加载
                console.log('尝试使用Trunk服务器配置的MIME类型加载');
                throw new Error('WASM文件类型不正确，尝试使用Trunk MIME类型');
            }
            return response;
        }

        // 验证WASM二进制文件
        function validateWasmBinary(bytes, wasmPath) {
            console.log('WASM二进制文件加载成功，大小:', bytes.byteLength);
            // 检查前几个字节是否是WASM魔术数字(00 61 73 6d)
            const view = new DataView(bytes);
            const magic = view.getUint32(0, true);
            if (magic !== 0x6d736100) {
                console.error('WASM文件格式错误: 不是有效的WebAssembly二进制文件');
                console.error('前4个字节:', view.getUint8(0).toString(16), view.getUint8(1).toString(16), view.getUint8(2).toString(16), view.getUint8(3).toString(16));
                // 尝试查看文件内容的前100个字符，判断是否是HTML
                const decoder = new TextDecoder();
                const content = decoder.decode(new Uint8Array(bytes, 0, Math.min(100, bytes.byteLength)));
                console.error('文件内容预览:', content);
                
                if (content.includes('<!DOCTYPE html>') || content.includes('<html')) {
                    console.error('WASM文件实际上是HTML文档，可能是路径错误或服务器配置问题');
                    // 尝试使用Trunk服务器的路径（移除/dist前缀）
                    let trunkPath = wasmPath;
                    if (trunkPath.startsWith('/dist/')) {
                        trunkPath = trunkPath.substring('/dist/'.length);
                    }
                    console.log(`尝试使用Trunk服务器路径加载WASM文件: ${trunkPath}`);
                    loadWasmBinary(trunkPath);
                } else {
                    console.error('WASM文件格式错误，但不是HTML文档');
                }
                throw new Error('WASM文件格式错误');
            }
            return bytes;
        }

        // 实例化WASM模块
        function instantiateWasmModule(bytes) {
            console.log('尝试实例化WebAssembly模块');
            return WebAssembly.instantiate(bytes, {
                env: {
                    // 添加必要的环境变量
                    memory: new WebAssembly.Memory({ initial: 10, maximum: 100 }),
                    table: new WebAssembly.Table({ initial: 0, element: 'anyfunc' }),
                    // 添加必要的函数
                    // 实现getStringFromWasm0函数用于错误处理
                    getStringFromWasm0: function(ptr, len) {
                        const mem = new Uint8Array(this.memory.buffer, ptr, len);
                        return new TextDecoder('utf-8').decode(mem);
                    },
                    __wbindgen_throw: function(ptr, len) {
                        throw new Error(this.getStringFromWasm0(ptr, len));
                    }
                    // 添加其他必要的函数...
                },
                wasi_snapshot_preview1: {}
            })
            .then(result => {
                console.log('WebAssembly模块实例化成功', result.instance);
                window.wasm = result.instance.exports;
                console.log('WASM导出函数:', Object.keys(window.wasm));
                // 尝试调用模块的方法
                if (window.wasm.start) {
                    console.log('尝试调用WebAssembly模块的start方法');
                    window.wasm.start();
                }
                return result;
            })
            .catch(error => {
                console.error('WebAssembly模块实例化失败:', error);
                console.error('错误堆栈:', error.stack);
                throw error;
            });
        }

        // 处理WASM二进制文件加载错误
        function handleWasmBinaryError(error, wasmPath) {
            console.error('WASM二进制文件加载或实例化失败:', error);
            // 尝试使用Trunk服务器配置的MIME类型加载
            if (!error.message.includes('Trunk MIME类型')) {
                console.log('尝试使用Trunk服务器配置的MIME类型加载');
                loadWasmBinaryWithTrunkMime(wasmPath);
            }
        }

        // 使用Trunk服务器配置的MIME类型加载WASM文件
        function loadWasmBinaryWithTrunkMime(wasmPath) {
            console.log('尝试使用Trunk服务器配置的MIME类型加载WASM文件:', wasmPath);
            // Trunk默认使用application/octet-stream作为WASM文件的MIME类型
            fetch(wasmPath, { headers: { 'Accept': 'application/octet-stream' } })
                .then(response => checkResponseStatus(response, wasmPath))
                .then(response => {
                    // 检查文件类型
                    const contentType = response.headers.get('content-type');
                    console.log('使用Trunk MIME类型加载的WASM文件类型:', contentType);
                    return response.arrayBuffer();
                })
                .then(bytes => {
                    console.log('使用Trunk MIME类型加载的WASM二进制文件大小:', bytes.byteLength);
                    return validateWasmBinary(bytes, wasmPath);
                })
                .then(bytes => instantiateWasmModule(bytes))
                .catch(error => {
                    console.error('使用Trunk MIME类型加载WASM二进制文件失败:', error);
                    // 尝试使用Trunk服务器的路径
                    if (error.message.includes('WASM文件格式错误') || error.message.includes('不是有效的WebAssembly二进制文件')) {
                        const trunkPath = `/dist/${wasmPath.split('/').pop()}`;
                        if (trunkPath !== wasmPath) {
                            console.log(`尝试使用Trunk服务器路径加载WASM文件: ${trunkPath}`);
                            loadWasmBinaryWithTrunkMime(trunkPath);
                        }
                    }
                });
          }
        
        // 初始化应用函数
        async function initApp() {
          try {
              // 首先确保Tauri完全加载
              console.log('页面加载开始，检查window.__TAURI__');
              let tauri;
              if (window.__TAURI__) {
                  console.log('Tauri已存在于全局作用域');
                  tauri = window.__TAURI__;
              } else {
                  console.log('Tauri未加载，尝试加载Tauri脚本');
                  tauri = await loadTauriScript();
              }
              console.log('Tauri已加载，初始化应用...');
                
                // 保存Tauri引用到全局，无论invoke是否可用
                window.tauri = tauri;
                
                // 检查Tauri invoke函数
                if (tauri && typeof tauri.invoke === 'function') {
                    console.log('Tauri invoke函数可用');
                } else {
                    console.warn('Tauri invoke函数不可用');
                }
                
                // 无论Tauri invoke是否可用，都尝试加载WebAssembly模块
                console.log('尝试加载WebAssembly模块');
                loadWasmModule();
            } catch (error) {
                console.error('应用初始化失败:', error);
                console.error('错误堆栈:', error.stack);
            }
        }
        
        // 统一的Tauri初始化和应用加载逻辑
        async function initTauriAndApp() {
            console.log('页面加载开始，检查window.__TAURI__:', window.__TAURI__);
            
            try {
                // 首先尝试使用全局Tauri
                if (window.__TAURI__) {
                    console.log('Tauri已存在于全局作用域');
                    // 检查并打印Tauri的所有属性
                    const tauriProps = Object.keys(window.__TAURI__);
                    console.log('Tauri属性:', tauriProps);
                    
                    // 检查Tauri是否需要初始化
                    if (window.__TAURI__.init) {
                        try {
                            await window.__TAURI__.init();
                            console.log('Tauri初始化成功');
                            // 初始化后再次检查invoke
                            console.log('初始化后invoke函数:', typeof window.__TAURI__.invoke);
                        } catch (error) {
                            console.error('Tauri初始化失败:', error);
                            console.error('错误堆栈:', error.stack);
                            // 尝试重新加载Tauri
                            console.log('尝试重新加载Tauri...');
                            await loadTauriScript();
                        }
                    } else {
                        console.log('Tauri不需要初始化');
                    }
                } else {
                    console.log('Tauri未加载，尝试加载...');
                    await loadTauriScript();
                }

                // 尝试获取invoke函数
                if (window.__TAURI__) {
                    // 保存Tauri引用到全局
                    window.tauri = window.__TAURI__;
                    
                    // 检查invoke函数
                    if (typeof window.tauri.invoke !== 'function') {
                        console.warn('Tauri invoke函数不可用，尝试其他方式获取');
                        
                        // 检查是否有api属性
                        if (window.tauri.api) {
                            console.log('Tauri api属性:', Object.keys(window.tauri.api));
                            if (window.tauri.api.invoke) {
                                window.tauri.invoke = window.tauri.api.invoke;
                                console.log('从api属性获取到invoke函数');
                            }
                        }
                        
                        // 检查是否有core属性
                        if (window.tauri.core && !window.tauri.invoke) {
                            console.log('Tauri core属性:', Object.keys(window.tauri.core));
                            if (window.tauri.core.invoke) {
                                window.tauri.invoke = window.tauri.core.invoke;
                                console.log('从core属性获取到invoke函数');
                            }
                        }
                        
                        // 最后检查是否存在getAPI方法
                        if (!window.tauri.invoke && window.tauri.getAPI) {
                            try {
                                const api = window.tauri.getAPI();
                                console.log('通过getAPI获取的API:', Object.keys(api));
                                if (api.invoke) {
                                    window.tauri.invoke = api.invoke;
                                    console.log('通过getAPI获取到invoke函数');
                                }
                            } catch (error) {
                                console.error('尝试通过getAPI获取invoke函数失败:', error);
                            }
                        }
                        
                        // 如果仍然没有获取到invoke函数，尝试直接加载WebAssembly模块
                        if (!window.tauri.invoke) {
                            console.warn('无法获取Tauri invoke函数，尝试直接加载WebAssembly模块');
                            loadWasmModule();
                        }
                    }
                } else {
                    console.warn('Tauri未加载，无法使用Tauri API');
                    // 尝试直接加载WebAssembly模块
                    loadWasmModule();
                }

                // 初始化应用
                initApp();
            } catch (error) {
                console.error('初始化过程发生错误:', error);
                console.error('错误堆栈:', error.stack);
                // 即使出错也尝试初始化应用
                initApp();
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initTauriAndApp);
    </script>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <h1 class="text-2xl font-bold mb-8 text-center">90分钟圆环倒计时</h1>
    <!-- 测试按钮将通过JavaScript动态添加 -->
    <div id="app-container" class="w-full max-w-md"></div>

    <div id="app"></div>
    <button id="test-tauri" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4">测试Tauri API</button>
    <!-- 已启用上面的模块类型脚本 -->
</body>

</html>